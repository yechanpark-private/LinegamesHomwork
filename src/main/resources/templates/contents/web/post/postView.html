<!-- 실제 게시글을 보여주는 뷰 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{layouts/layout}">

<head>
    <title>Community Page</title>
</head>

<body>

<div layout:fragment="content">

    <main role="main" class="container my-5 p-5">

        <div class="row">

            <!-- Post Content Column -->
            <div class="col-lg-12">
                <a class="btn btn-secondary" th:href="@{/board/} + ${redirectBoardURI}">< 게시판으로 돌아가기</a>

                <!-- Title -->
                <h1 class="mt-4" th:text="${post.title}">Post Title</h1>
                <!-- Author -->
                <p class="lead">by <span th:text="${post.author.username}">Author</span></p>

                <hr>

                <!-- Date/Time -->
                <p>Posted on
                    <th:block th:text="${post.addDate}"></th:block>
                </p>

                <!-- 로그인한 사람만 수행 가능-->
                <th:block sec:authorize="isAuthenticated()">
                    <a th:href="@{/post/add/child/} + ${post.id}" class="btn btn-warning">답글 달기</a>

                    <!-- 권한이 MEMBER인 경우에는 작성자 본인이거나, 권한이 ADMIN인 경우 접근 가능 -->
                    <th:block
                            th:if="(${#authentication.principal.id} == ${post.author.id}) OR ${#authorization.expression('hasAuthority(''ROLE_ADMIN'')')}">
                        <a th:href="@{/post/update/} + ${post.id}" class="btn btn-warning">게시글 수정</a>
                        <a th:onclick="|deletePost(${post.id})|" class="btn btn-danger">게시글 삭제</a>
                    </th:block>


                    <hr>

                    <!-- Preview Image -->
                    <img class="img-fluid rounded" src="http://placehold.it/900x300" alt="">

                    <hr>

                    <!-- Post Content -->
                    <p class="lead" th:text="${post.content}"></p>

                    <hr>

                    <!-- Comments Form -->
                    <th:block sec:authorize="isAuthenticated()">
                        <div class="card my-4">
                            <h5 class="card-header">Leave a Comment:</h5>
                            <div class="card-body">
                                <form method="post" th:action="@{/comment/} + ${post.id}">
                                    <div class="form-group">
                                        <textarea name="content" class="form-control" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </form>
                            </div>
                        </div>
                    </th:block>

                    <!-- 댓글 리스트 출력 -->
                    <th:block th:each="comment : ${post.comments}">
                        <div class="media mb-4">
                            <!--<img class="d-flex mr-3 rounded-circle" src="http://placehold.it/50x50" alt="">-->
                            <div class="media-body">
                                <h5 class="mt-0" th:text="${comment.author.username}">Commenter Name</h5>
                                <th:block th:text="${comment.content}"></th:block>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>

        </div>
        <!-- /.row -->

    </main>

    <script>
        function deletePost(postId) {

            let deleteConfirm = confirm("게시글을 삭제하시겠습니까?");

            // 글 삭제 확인
            if (deleteConfirm == true) {
               let contextPath = $('#contextPathHolder').attr('data-contextPath');

                $.ajax({
                    url: contextPath + '/post/rest/' + postId,
                    type: 'delete',
                    success: function(result) {

                        if( !result.errorCode ){
                            alert('게시글이 삭제되었습니다.');
                            location.href = contextPath + '/board/' + result.data.boardURI;
                        }

                        else {
                            alert(result.errorMessage);
                        }
                    },
                    fail: function() {
                        alert('게시글 삭제 요청이 실패했습니다.');
                    }
                });
            }
        }

    </script>

</div>
</body>
</html>